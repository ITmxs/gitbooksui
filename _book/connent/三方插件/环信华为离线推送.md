前言：(本人苹果开发人员)由于项目中im用的是环信推送用的是极光，所以在环信的消息离线推送多厂商配置中华为就出来闹事儿了，需要单独在安卓原生里添加注册华为厂商token方法，因为获取不到就向环信平台请教了下，结论是需要极光平台提供token（自家的方法却需要其他平台提供不得不说 真不错！！！）

> ## 一.极光获取厂商token

> 打开AndroidStudio，找到极光插件

![img](https:////upload-images.jianshu.io/upload_images/22818555-d13203e97c236da3.png?imageMogr2/auto-orient/strip|imageView2/2/w/980/format/webp)

image.png

> 在  public class JPushEventReceiver extends JPushMessageReceiver {... 处添加获取厂商token方法，如下



```java
public class JPushEventReceiver extends JPushMessageReceiver {
private String TAG = "jiguang";
///此处接口注册 定义对象
public static ShowCallBack mShowCallBack;
public static interface  ShowCallBack{
    void onShown(String value);
}
public static void setShowCallBack(ShowCallBack c){
    mShowCallBack = c;
}
///

@Override
public void onCommandResult(Context context, CmdMessage cmdMessage) {

    //注册失败+三方厂商注册回调
  //  Log.e(TAG,"[onCommandResult] "+cmdMessage);
    //cmd为10000时说明为厂商token回调
    if(cmdMessage!=null&&cmdMessage.cmd==10000&&cmdMessage.extra!=null){
        String token = cmdMessage.extra.getString("token");
        int platform = cmdMessage.extra.getInt("platform");
        String deviceName = "unkown";
        switch (platform){
            case 1:
                deviceName = "小米";
                break;
            case 2:
                deviceName = "华为";
                break;
            case 3:
                deviceName = "魅族";
                break;
            case 4:
                deviceName = "OPPO";
                break;
            case 5:
                deviceName = "VIVO";
                break;
            case 6:
                deviceName = "ASUS";
                break;
            case 8:
                deviceName = "FCM";
                break;
        }
        ///此处 接口回调 赋值
        mShowCallBack.onShown(token);
        setShowCallBack(mShowCallBack);
        ///

       Log.e(TAG,"获取到 "+deviceName+" 的token:"+token);

    }

}
```

> 继而打开JPushPlugin文件
>
> ![img](https:////upload-images.jianshu.io/upload_images/22818555-19eb60b1a1c75665.png?imageMogr2/auto-orient/strip|imageView2/2/w/874/format/webp)
>
> image.png



```java
///与public void getRegistrationID(MethodCall call, Result result) {} 同级
///添加自定义 获取华为token 方法
public void getSCToken(MethodCall call ,final Result result) {
    JPushEventReceiver rec = new JPushEventReceiver();
    rec.setShowCallBack(new JPushEventReceiver.ShowCallBack(){
        @Override
        public void onShown(final String token){
            android.os.Handler handler = new Handler(Looper.getMainLooper());
            handler.post(new Runnable() {
                @Override
                public void run(){
                    result.success(token);
                }
            });
            Log.e(TAG,"获取到的token:"+token);
        }
    });
}
```

> 然后在public void onMethodCall(MethodCall call, Result result) {}内添加获取方法



```csharp
 public void onMethodCall(MethodCall call, Result result) {
   ....
    else if (call.method.equals("getSCToken")) {
        getSCToken(call, result);
    }
  ....
 }
```

> 找到 push_flutter.dart(找不到可以全局搜索 getRegistrationID 😄)，并在其内部添加flutter层调用方法



```rust
 ///
 /// 获取 厂商token。
 ///
 /// @param {Function} callback = (String) => {}
 ///
Future<String> getScTokens() async {
 print(flutter_log + "getScTokens:");
final String token = await _channel.invokeMethod('getSCToken');
return token;
}
```

> 最后在flutter main.dart 中获取即可(特别注意，这些操作是写在插件原生中的，插件升级或者从新download都会到这这些代码重置，可以收藏文章，以备后用)



```dart
jpush.getScTokens().then((value) => print('安卓回调的华为的token：$value'));
```

> ## 二.环信(离线消息推送)注册华为token

> 同极光推送一样，找到环信im插件原生代码添加下述代码



```dart
/// 注册华为厂商token
Future<String> resigterToken(String hwappid, String hwToken) async{
Map req = {
  'hwappid': hwappid,
  'hwToken': hwToken,
};
 await _channel.invokeMethod(EMSDKMethod.hwtoken, req);

return "注册华为厂商token ";
}
```

> 结果如图：
>
> ![img](https:////upload-images.jianshu.io/upload_images/22818555-1ed15e90fa5f869f.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)
>
> image.png
>
> 注册hwtoken方法如图所示
>
> ![img](https:////upload-images.jianshu.io/upload_images/22818555-ac14dba6b184232f.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)
>
> image.png
>
> 然后在 _channel 通道创建这个 hwtoken 方法如图所示：
>
> ![img](https:////upload-images.jianshu.io/upload_images/22818555-cafc954a48b6ebdf.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)
>
> image.png

> 至此便可在flutter中进行华为的token注册了



```csharp
await EMClient.getInstance.resigterToken("华为appid",“华为token”)
```

> 特别注意官方文档中提到过hms华为的token注册应该放在环信注册成功后

> ### 有什么不懂得欢迎下方留言，技术不易，点赞支持呦！！！



